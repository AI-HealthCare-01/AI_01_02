Project AI_Health_Development_Baseline {
  database_type: "MySQL"
  Note: 'Development ERD (2026-02-24). Includes only implemented tables and directly planned tables for next milestones. Deferred domains are intentionally excluded to avoid design noise.'
}

// Excluded intentionally in this baseline:
// - knowledge_sources / knowledge_documents / knowledge_chunks / vector_index_mappings
// - prompt_versions / model_versions / inference_audits / external_api_call_logs
// - reminder_schedule_times / reminder_delivery_logs / medication_supply_states

Enum gender_enum {
  MALE
  FEMALE
}

Enum notification_type_enum {
  SYSTEM
  HEALTH_ALERT
  REPORT_READY
  GUIDE_READY
}

Enum document_type_enum {
  MEDICAL_RECORD
  PRESCRIPTION
  MEDICATION_BAG
}

Enum ocr_job_status_enum {
  QUEUED
  PROCESSING
  SUCCEEDED
  FAILED
}

Enum ocr_failure_code_enum {
  FILE_NOT_FOUND
  INVALID_STATE_TRANSITION
  PROCESSING_ERROR
}

Enum ocr_review_status_enum {
  PENDING
  CONFIRMED
  CORRECTED
}

Enum intake_time_enum {
  MORNING
  LUNCH
  DINNER
  BEDTIME
  PRN
}

Enum administration_timing_enum {
  BEFORE_MEAL
  AFTER_MEAL
  WITH_MEAL
  IRRELEVANT
}

Enum guide_job_status_enum {
  QUEUED
  PROCESSING
  SUCCEEDED
  FAILED
}

Enum guide_failure_code_enum {
  OCR_NOT_READY
  OCR_RESULT_NOT_FOUND
  INVALID_STATE_TRANSITION
  PROCESSING_ERROR
}

Enum guide_risk_level_enum {
  LOW
  MEDIUM
  HIGH
}

Enum chat_session_status_enum {
  ACTIVE
  CLOSED
}

Enum chat_role_enum {
  USER
  ASSISTANT
  SYSTEM
}

Enum chat_intent_enum {
  SMALLTALK
  MEDICAL
  CRISIS
}

Enum guardrail_type_enum {
  SUICIDE
  SELF_HARM
  CRIME
  DRUG_ABUSE
}

Enum guardrail_action_enum {
  BLOCK_AND_EMERGENCY_MESSAGE
  ALLOW
}

// ----------------------------------------------------------------------
// Account and profile domain
// ----------------------------------------------------------------------
// [Implemented]
Table users {
  id bigint [pk, increment, not null]
  email varchar(40) [not null]
  hashed_password varchar(128) [not null]
  name varchar(20) [not null]
  gender gender_enum [not null]
  birthday date [not null]
  phone_number varchar(11) [not null]
  is_active boolean [not null, default: true]
  is_admin boolean [not null, default: false]
  last_login datetime(6)
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]
  updated_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  Note: 'Core account table. Duplicate email/phone currently guarded in application logic.'
}

// [Planned]
Table health_profiles {
  id bigint [pk, increment, not null]
  user_id bigint [not null, unique]
  basic_info json [not null]
  medical_history json [not null]
  lifestyle_input json [not null]
  sleep_input json [not null]
  nutrition_input json [not null]
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]
  updated_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  Note: 'Used by REQ-046/047 and guide personalization context.'

  indexes {
    (user_id) [name: 'idx_health_profiles_user_id', unique]
  }
}

// ----------------------------------------------------------------------
// OCR domain
// ----------------------------------------------------------------------
// [Implemented]
Table documents {
  id bigint [pk, increment, not null]
  user_id bigint [not null]
  document_type document_type_enum [not null]
  file_name varchar(255) [not null]
  file_path varchar(500) [not null]
  file_size bigint [not null]
  mime_type varchar(100) [not null]
  uploaded_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  Note: 'Upload metadata only. Raw file is temporary and must be disposed after OCR completion/final failure and queue publish failure.'

  indexes {
    (user_id, uploaded_at) [name: 'idx_documents_user_uploaded_at']
    (document_type) [name: 'idx_documents_document_type']
  }
}

// [Implemented]
Table ocr_jobs {
  id bigint [pk, increment, not null]
  user_id bigint [not null]
  document_id bigint [not null]
  status ocr_job_status_enum [not null, default: 'QUEUED']
  retry_count int [not null, default: 0]
  max_retries int [not null, default: 3]
  failure_code ocr_failure_code_enum
  error_message longtext
  queued_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]
  started_at datetime(6)
  completed_at datetime(6)
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]
  updated_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  indexes {
    (user_id, status) [name: 'idx_ocr_jobs_user_status']
    (document_id, created_at) [name: 'idx_ocr_jobs_document_created_at']
    (status, retry_count) [name: 'idx_ocr_jobs_status_retry_count']
  }
}

// [Implemented]
Table ocr_results {
  id bigint [pk, increment, not null]
  job_id bigint [not null, unique]
  extracted_text longtext [not null]
  structured_data json [not null]
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]
  updated_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  Note: 'Review metadata columns (confidence/review status/comment) are planned for a later migration and are not in the current schema.'
}

// [Planned]
Table medications {
  id bigint [pk, increment, not null]
  drug_code varchar(100) [not null, unique]
  name_ko varchar(255) [not null]
  name_en varchar(255)
  ingredient varchar(255) [not null]
  is_adhd_target boolean [not null, default: true]
  guidance json
  side_effects json
  is_active boolean [not null, default: true]
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]
  updated_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  Note: 'ADHD medication dictionary for REQ-041 validation/mapping.'

  indexes {
    (name_ko) [name: 'idx_medications_name_ko']
    (ingredient) [name: 'idx_medications_ingredient']
  }
}

// [Planned]
Table ocr_medications {
  id bigint [pk, increment, not null]
  ocr_result_id bigint [not null]
  line_index int [not null]
  raw_drug_name varchar(255) [not null]
  normalized_drug_name varchar(255)
  medication_id bigint
  dose_mg decimal(8,3)
  frequency_per_day int
  dosage_per_once decimal(6,2)
  intake_time intake_time_enum
  administration_timing administration_timing_enum
  dispensed_date date
  total_days int
  confidence decimal(5,4)
  field_confidence json
  is_user_corrected boolean [not null, default: false]
  is_confirmed boolean [not null, default: false]
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]
  updated_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  Note: 'Normalized OCR medication rows for confirm/edit flow and D-day calculation.'

  indexes {
    (ocr_result_id, line_index) [name: 'idx_ocr_medications_result_line', unique]
    (medication_id) [name: 'idx_ocr_medications_medication_id']
  }
}

// ----------------------------------------------------------------------
// Guide domain
// ----------------------------------------------------------------------
// [Implemented]
Table guide_jobs {
  id bigint [pk, increment, not null]
  user_id bigint [not null]
  ocr_job_id bigint [not null]
  status guide_job_status_enum [not null, default: 'QUEUED']
  retry_count int [not null, default: 0]
  max_retries int [not null, default: 3]
  failure_code guide_failure_code_enum
  error_message longtext
  queued_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]
  started_at datetime(6)
  completed_at datetime(6)
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]
  updated_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  indexes {
    (user_id, status) [name: 'idx_guide_jobs_user_status']
    (ocr_job_id, created_at) [name: 'idx_guide_jobs_ocr_job_created_at']
    (status, retry_count) [name: 'idx_guide_jobs_status_retry_count']
  }
}

// [Implemented]
Table guide_results {
  id bigint [pk, increment, not null]
  job_id bigint [not null, unique]
  medication_guidance longtext [not null]
  lifestyle_guidance longtext [not null]
  risk_level guide_risk_level_enum [not null, default: 'MEDIUM']
  safety_notice longtext [not null]
  structured_data json [not null]
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]
  updated_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  Note: 'Structured guide fields, trace metadata, and analysis summary can be stored in structured_data JSON.'
}

// ----------------------------------------------------------------------
// Chat domain
// ----------------------------------------------------------------------
// [Planned]
Table chat_sessions {
  id bigint [pk, increment, not null]
  user_id bigint [not null]
  title varchar(255)
  status chat_session_status_enum [not null, default: 'ACTIVE']
  auto_close_after_minutes smallint [not null, default: 20]
  last_activity_at datetime(6)
  closed_at datetime(6)
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]
  updated_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  indexes {
    (user_id, status) [name: 'idx_chat_sessions_user_status']
    (status, last_activity_at) [name: 'idx_chat_sessions_status_last_activity']
  }
}

// [Planned]
Table chat_messages {
  id bigint [pk, increment, not null]
  session_id bigint [not null]
  role chat_role_enum [not null]
  intent chat_intent_enum
  content longtext [not null]
  needs_clarification boolean [not null, default: false]
  similarity_top_score decimal(6,4)
  model_version_tag varchar(100)
  prompt_version_tag varchar(100)
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  indexes {
    (session_id, created_at) [name: 'idx_chat_messages_session_created_at']
    (role) [name: 'idx_chat_messages_role']
  }
}

// [Planned]
Table chat_message_references {
  id bigint [pk, increment, not null]
  message_id bigint [not null]
  external_document_id varchar(255)
  title varchar(500) [not null]
  source varchar(255) [not null]
  url varchar(1000)
  score decimal(6,4)
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  indexes {
    (message_id, score) [name: 'idx_chat_message_references_message_score']
  }
}

// [Planned]
Table chat_guardrail_events {
  id bigint [pk, increment, not null]
  session_id bigint [not null]
  message_id bigint
  guardrail_type guardrail_type_enum [not null]
  action guardrail_action_enum [not null]
  trigger_terms json
  emergency_message longtext
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  indexes {
    (session_id, created_at) [name: 'idx_chat_guardrail_events_session_created_at']
    (guardrail_type, created_at) [name: 'idx_chat_guardrail_events_type_created_at']
  }
}

// ----------------------------------------------------------------------
// Notification and reminder domain
// ----------------------------------------------------------------------
// [Implemented]
Table notifications {
  id bigint [pk, increment, not null]
  user_id bigint [not null]
  type notification_type_enum [not null, default: 'SYSTEM']
  title varchar(100) [not null]
  message longtext [not null]
  is_read boolean [not null, default: false]
  read_at datetime(6)
  payload json [not null]
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  indexes {
    (user_id, is_read) [name: 'idx_notifications_user_is_read']
    (user_id, created_at) [name: 'idx_notifications_user_created_at']
  }
}

// [Planned]
Table medication_reminders {
  id bigint [pk, increment, not null]
  user_id bigint [not null]
  source_ocr_medication_id bigint
  medication_name_snapshot varchar(255) [not null]
  dose_text varchar(100)
  schedule_times json [not null]
  start_date date
  end_date date
  enabled boolean [not null, default: true]
  last_sent_at datetime(6)
  created_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]
  updated_at datetime(6) [not null, default: `CURRENT_TIMESTAMP(6)`]

  Note: 'Single-table reminder design (schedule_times JSON) to support CRUD without split schedule tables.'

  indexes {
    (user_id, enabled) [name: 'idx_medication_reminders_user_enabled']
    (user_id, medication_name_snapshot) [name: 'idx_medication_reminders_user_med_name']
  }
}

// ----------------------------------------------------------------------
// Relationships
// ----------------------------------------------------------------------
Ref: users.id - health_profiles.user_id [delete: cascade]
Ref: users.id < documents.user_id [delete: cascade]
Ref: users.id < ocr_jobs.user_id [delete: cascade]
Ref: documents.id < ocr_jobs.document_id [delete: cascade]
Ref: ocr_jobs.id - ocr_results.job_id [delete: cascade]
Ref: ocr_results.id < ocr_medications.ocr_result_id [delete: cascade]
Ref: medications.id < ocr_medications.medication_id
Ref: users.id < guide_jobs.user_id [delete: cascade]
Ref: ocr_jobs.id < guide_jobs.ocr_job_id [delete: cascade]
Ref: guide_jobs.id - guide_results.job_id [delete: cascade]
Ref: users.id < chat_sessions.user_id [delete: cascade]
Ref: chat_sessions.id < chat_messages.session_id [delete: cascade]
Ref: chat_messages.id < chat_message_references.message_id [delete: cascade]
Ref: chat_sessions.id < chat_guardrail_events.session_id [delete: cascade]
Ref: chat_messages.id < chat_guardrail_events.message_id [delete: set null]
Ref: users.id < notifications.user_id [delete: cascade]
Ref: users.id < medication_reminders.user_id [delete: cascade]
Ref: ocr_medications.id < medication_reminders.source_ocr_medication_id [delete: set null]
